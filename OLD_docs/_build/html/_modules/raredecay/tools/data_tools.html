

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>raredecay.tools.data_tools &mdash; raredecay 1.2.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="raredecay 1.2.1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> raredecay
          

          
          </a>

          
            
            
              <div class="version">
                1.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../raredecay.html">Raredecay Analysis Package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">raredecay</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>raredecay.tools.data_tools</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for raredecay.tools.data_tools</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue Mar 29 17:53:18 2016</span>

<span class="sd">@author: Jonas Eschle &quot;Mayou36&quot;</span>

<span class="sd">Contains several tools to convert, load, save and plot data</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">root_numpy</span> <span class="k">import</span> <span class="n">root2array</span><span class="p">,</span> <span class="n">array2root</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;could not import from root_numpy!&quot;</span><span class="p">)</span>


<span class="c1"># both produce error (27.07.2016) when importing them if run from main.py.</span>
<span class="c1"># No problem when run as main...</span>

<span class="c1"># from raredecay.tools import dev_tool</span>
<span class="kn">from</span> <span class="nn">raredecay</span> <span class="k">import</span> <span class="n">meta_config</span>


<span class="k">def</span> <span class="nf">apply_cuts</span><span class="p">(</span><span class="n">signal_data</span><span class="p">,</span> <span class="n">bkg_data</span><span class="p">,</span> <span class="n">percent_sig_to_keep</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">bkg_length</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Search for best cut on value to still keep percent_sig_to_keep of signal</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signal_data : 1-D numpy array</span>
<span class="sd">        The signal</span>
<span class="sd">    bkg_data : 1-D numpy array</span>
<span class="sd">        The background data</span>
<span class="sd">    percent_sig_to_keep : 0 &lt; float &lt;= 100</span>
<span class="sd">        What percentage of the data to keep in order to apply the cuts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    if percent_sig_to_keep &lt; 100:</span>
<span class="c1">#        raise NotImplementedError(&quot;percentage of &lt; 100 not yet imlemented&quot;)</span>
    <span class="n">percentile</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">percent_sig_to_keep</span><span class="p">]</span>  <span class="c1"># TODO: modify for percent_sig_to_keep</span>
    <span class="n">bkg_length_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bkg_data</span><span class="p">)</span>
    <span class="n">bkg_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bkg_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">bkg_length</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">bkg_length</span>

    <span class="n">lower_cut</span><span class="p">,</span> <span class="n">upper_cut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">signal_data</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
    <span class="n">cut_bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">bkg_data</span> <span class="o">&lt;</span> <span class="n">lower_cut</span><span class="p">,</span> <span class="n">bkg_data</span> <span class="o">&gt;</span> <span class="n">upper_cut</span><span class="p">))</span>
    <span class="n">rejected_bkg</span> <span class="o">=</span> <span class="p">(</span><span class="n">bkg_length_before</span> <span class="o">-</span> <span class="n">cut_bkg</span><span class="p">)</span> <span class="o">/</span> <span class="n">bkg_length</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">lower_cut</span><span class="p">,</span> <span class="n">upper_cut</span><span class="p">],</span> <span class="n">rejected_bkg</span>


<div class="viewcode-block" id="make_root_dict"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.make_root_dict">[docs]</a><span class="k">def</span> <span class="nf">make_root_dict</span><span class="p">(</span><span class="n">path_to_rootfile</span><span class="p">,</span> <span class="n">tree_name</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a root_numpy compatible &quot;root-dict&quot; of a root-tree.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_to_rootfile : str</span>
<span class="sd">        The exact path to the root-tree including the filename. Example:</span>
<span class="sd">        /home/user1/data/myRootTree1.root</span>
<span class="sd">    tree_name : str</span>
<span class="sd">        The name of the tree</span>
<span class="sd">    branches : str or list[str, str, str,... ]</span>
<span class="sd">        The branches of the tree to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filenames</span><span class="o">=</span><span class="n">path_to_rootfile</span><span class="p">,</span>
                  <span class="n">treename</span><span class="o">=</span><span class="n">tree_name</span><span class="p">,</span>
                  <span class="n">branches</span><span class="o">=</span><span class="n">branches</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span></div>


<span class="k">def</span> <span class="nf">add_to_rootfile</span><span class="p">(</span><span class="n">rootfile</span><span class="p">,</span> <span class="n">new_branch</span><span class="p">,</span> <span class="n">branch_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds a new branch to a given root file.</span>

<span class="sd">    .. warning:: Overwrite not working currently!</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rootfile : root-dict</span>
<span class="sd">        The ROOT-file where the data should be added</span>
<span class="sd">    new_branch : numpy.array 1-D, list, root-dict</span>
<span class="sd">        A one-dimensional numpy array that contains the data.</span>
<span class="sd">    branch_name : str</span>
<span class="sd">        The name of the branche resp. the name in the dtype of the array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># from root_numpy import root2array, array2tree</span>

    <span class="kn">from</span> <span class="nn">rootpy.io</span> <span class="k">import</span> <span class="n">root_open</span>
    <span class="kn">from</span> <span class="nn">ROOT</span> <span class="k">import</span> <span class="n">TObject</span>
    <span class="c1"># get the right parameters</span>
    <span class="c1"># TODO: what does that if there? an assertion maybe?</span>
    <span class="n">write_mode</span> <span class="o">=</span> <span class="s1">&#39;update&#39;</span>
    <span class="n">branch_name</span> <span class="o">=</span> <span class="s1">&#39;new_branch1&#39;</span> <span class="k">if</span> <span class="n">branch_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">branch_name</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rootfile</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">rootfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filenames&#39;</span><span class="p">)</span>
    <span class="n">treename</span> <span class="o">=</span> <span class="n">rootfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;treename&#39;</span><span class="p">)</span>
    <span class="n">new_branch</span> <span class="o">=</span> <span class="n">to_ndarray</span><span class="p">(</span><span class="n">new_branch</span><span class="p">)</span>
<span class="c1">#    new_branch.dtype = [(branch_name, &#39;f8&#39;)]</span>

    <span class="c1"># write to ROOT-file</span>
    <span class="n">write_to_root</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">root_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">root_file</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">root_file</span><span class="p">,</span> <span class="n">treename</span><span class="p">)</span>  <span class="c1"># test</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tree</span><span class="o">.</span><span class="n">has_branch</span><span class="p">(</span><span class="n">branch_name</span><span class="p">):</span>
                <span class="n">write_to_root</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#            array2tree(new_branch, tree=tree)</span>
    <span class="c1">#            f.write(&quot;&quot;, TObject.kOverwrite)  # overwrite, does not create friends</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_mode</span> <span class="o">=</span> <span class="s1">&#39;recreate&#39;</span>
        <span class="n">write_to_root</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">write_to_root</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">([</span><span class="n">new_branch</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="n">branch_name</span><span class="p">)</span>
        <span class="n">array2root</span><span class="p">(</span><span class="n">arr</span><span class="o">=</span><span class="n">arr</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">treename</span><span class="o">=</span><span class="n">treename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">write_mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="c1"># TODO: remove? outdated</span>
<span class="k">def</span> <span class="nf">format_data_weights</span><span class="p">(</span><span class="n">data_to_shape</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format the data and the weights perfectly. Same length and more.</span>

<span class="sd">    Change the data to pandas.DataFrame and fill the weights with ones where</span>
<span class="sd">    nothing or None is specified. Returns both in lists.</span>
<span class="sd">    Very useful to loop over several data and weights.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_to_shape : (root_dict, numpy.array, pandas.DataFrame)</span>
<span class="sd">        The data for which we apply the weights. Usual 2-D shape.</span>
<span class="sd">    weights : (list, numpy.array, pandas.DataFrame, None)</span>
<span class="sd">        The weights to be reshaped</span>

<span class="sd">        *Best format* :</span>

<span class="sd">        [array(weights),array(weights), None, array(weights),...]</span>

<span class="sd">        *None* can be used if no special weights are specified.</span>
<span class="sd">        If weights contains less &quot;weight-containing array-like objects&quot; then</span>
<span class="sd">        data_to_shape does, the difference will be filled with *1*</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    out : list(pandas.DataFrame(data), pandas.DataFrame(data),...)</span>
<span class="sd">        Return a list containing data</span>
<span class="sd">    out : list(numpy.array(weight), numpy.array(weight),...)</span>
<span class="sd">        Return a list with the weights, converted and filled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># conver the data</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_to_shape</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">data_to_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_to_shape</span><span class="p">]</span>
    <span class="n">data_to_shape</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">to_pandas</span><span class="p">,</span> <span class="n">data_to_shape</span><span class="p">)</span>
    <span class="c1"># convert the weights</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">weights</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">weights</span><span class="p">]</span>
    <span class="c1"># convert to pandas</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;weights could not be converted to list&quot;</span>
    <span class="k">for</span> <span class="n">data_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_to_shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data_id</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weights</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">data_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_pandas</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">data_id</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">data_to_shape</span><span class="p">,</span> <span class="n">weights</span>


<div class="viewcode-block" id="obj_to_string"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.obj_to_string">[docs]</a><span class="k">def</span> <span class="nf">obj_to_string</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a string containing all objects as strings, separated by the separator.</span>

<span class="sd">    Useful for automatic conversion for different types. The following objects</span>
<span class="sd">    will automatically be converted:</span>

<span class="sd">    - None will be omitted</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objects : any object or list(obj, obj, ...) with a string representation</span>
<span class="sd">        The objects will be converted to a string and concatenated, separated</span>
<span class="sd">        by the separator.</span>
<span class="sd">    separator : str</span>
<span class="sd">        The separator between the objects. Default is &quot; - &quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># no need to change things</span>
        <span class="k">return</span> <span class="n">objects</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot; - &quot;</span> <span class="k">if</span> <span class="n">separator</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">separator</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Separator not a string&quot;</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>  <span class="c1"># remove Nones</span>
    <span class="n">string_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
        <span class="n">string_out</span> <span class="o">+=</span> <span class="n">word</span> <span class="o">+</span> <span class="n">separator</span> <span class="k">if</span> <span class="n">word</span> <span class="o">!=</span> <span class="n">objects</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">word</span>

    <span class="k">return</span> <span class="n">string_out</span></div>


<div class="viewcode-block" id="is_root"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.is_root">[docs]</a><span class="k">def</span> <span class="nf">is_root</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether a given data is a root file. Needs dicts to be True.&quot;&quot;&quot;</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">path_name</span> <span class="o">=</span> <span class="n">data_to_check</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filenames&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;&#39;filenames&#39; of the dictionary &quot;</span> <span class="o">+</span>
                                            <span class="nb">str</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;is not a string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">meta_config</span><span class="o">.</span><span class="n">ROOT_DATATYPE</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">flag</span></div>


<div class="viewcode-block" id="is_list"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.is_list">[docs]</a><span class="k">def</span> <span class="nf">is_list</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check whether the given data is a list.&quot;&quot;&quot;</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">flag</span></div>


<div class="viewcode-block" id="is_ndarray"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.is_ndarray">[docs]</a><span class="k">def</span> <span class="nf">is_ndarray</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether a given data is an ndarray.&quot;&quot;&quot;</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">flag</span></div>


<div class="viewcode-block" id="is_pickle"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.is_pickle">[docs]</a><span class="k">def</span> <span class="nf">is_pickle</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if the file is a pickled file (checks the ending).&quot;&quot;&quot;</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_to_check</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data_to_check</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">meta_config</span><span class="o">.</span><span class="n">PICKLE_DATATYPE</span><span class="p">):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">flag</span></div>


<div class="viewcode-block" id="to_list"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.to_list">[docs]</a><span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="n">data_in</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the data into a list. Does not pack lists into a new one.</span>

<span class="sd">    If your input is, for example, a string or a list of strings, or a</span>
<span class="sd">    tuple filled with strings, you have, in general, a problem:</span>

<span class="sd">    - just iterate through the object will fail because it iterates through the</span>
<span class="sd">      characters of the string.</span>
<span class="sd">    - using list(obj) converts the tuple, leaves the list but splits the strings</span>
<span class="sd">      characters into single elements of a new list.</span>
<span class="sd">    - using [obj] creates a list containing a string, but also a list containing</span>
<span class="sd">      a list or a tuple, which you did not want to.</span>

<span class="sd">    Solution: use to_list(obj), which creates a new list in case the object is</span>
<span class="sd">    a single object (a string is a single object in this sence) or converts</span>
<span class="sd">    to a list if the object is already a container for several objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_in : any obj</span>
<span class="sd">        So far, any object can be entered.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : list</span>
<span class="sd">        Return a list containing the object or the object converted to a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_in</span><span class="p">]</span>
    <span class="n">data_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_in</span></div>


<div class="viewcode-block" id="to_ndarray"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.to_ndarray">[docs]</a><span class="k">def</span> <span class="nf">to_ndarray</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="n">float_array</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert data to numpy array (containing only floats).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_in : any reasonable data</span>
<span class="sd">        The data to be converted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_root</span><span class="p">(</span><span class="n">data_in</span><span class="p">):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">root2array</span><span class="p">(</span><span class="o">**</span><span class="n">data_in</span><span class="p">)</span>  <span class="c1"># why **? it&#39;s a root dict</span>
    <span class="c1"># change numpy.void to normal floats</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
        <span class="n">test_sample</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_sample</span> <span class="o">=</span> <span class="n">data_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_sample</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">void</span><span class="p">):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data_in</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">data_in</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">is_list</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">float_array</span><span class="p">:</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfarray</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_ndarray</span><span class="p">(</span><span class="n">data_in</span><span class="p">),</span> <span class="s2">&quot;Error, could not convert data to numpy array&quot;</span>
    <span class="k">return</span> <span class="n">data_in</span></div>


<div class="viewcode-block" id="to_pandas"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.to_pandas">[docs]</a><span class="k">def</span> <span class="nf">to_pandas</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert data from numpy or root to pandas dataframe.</span>

<span class="sd">    Convert data safely to pandas, whatever the format is.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_in : any reasonable data</span>
<span class="sd">        The data to be converted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_root</span><span class="p">(</span><span class="n">data_in</span><span class="p">):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">root2array</span><span class="p">(</span><span class="o">**</span><span class="n">data_in</span><span class="p">)</span>  <span class="c1"># why **? it&#39;s a root dict</span>
    <span class="k">if</span> <span class="n">is_list</span><span class="p">(</span><span class="n">data_in</span><span class="p">):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_ndarray</span><span class="p">(</span><span class="n">data_in</span><span class="p">):</span>
        <span class="n">data_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_in</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Could not convert data to pandas. Data: &quot;</span> <span class="o">+</span> <span class="n">data_in</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_in</span></div>


<div class="viewcode-block" id="adv_return"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.adv_return">[docs]</a><span class="k">def</span> <span class="nf">adv_return</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">save_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the value if save_name specified, otherwise just return input.</span>

<span class="sd">    Can be wrapped around the return value. Without any arguments, the return</span>
<span class="sd">    of your function will be exactly the same. With arguments, the value can</span>
<span class="sd">    be saved (**pickled**) before it is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    return_value : any python object</span>
<span class="sd">        The python object which should be pickled.</span>
<span class="sd">    save_name : str, None</span>
<span class="sd">        | The (file-)name for the pickled file. File-extension will be added</span>
<span class="sd">        automatically if specified in *raredecay.meta_config*.</span>
<span class="sd">        | If *None* is passed, the object won&#39;t be pickled.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    out : python object</span>
<span class="sd">        Return return_value without changes.</span>

<span class="sd">    **Usage**:</span>
<span class="sd">     Instead of a simple return statement</span>

<span class="sd">     &gt;&gt;&gt; return my_variable/my_object</span>

<span class="sd">     one can use the **completely equivalent** statement</span>

<span class="sd">     &gt;&gt;&gt; return adv_return(my_variable/my_object)</span>

<span class="sd">     If the return value should be saved in addition to be returned, use</span>

<span class="sd">     &gt;&gt;&gt; return adv_return(my_variable/my_object, save_name=&#39;my_object.pickle&#39;)</span>

<span class="sd">      (*the .pickle ending is not required but added automatically if omitted*)</span>
<span class="sd">     which returns the value and saves it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">save_name</span> <span class="o">=</span> <span class="n">meta_config</span><span class="o">.</span><span class="n">PICKLE_PATH</span> <span class="o">+</span> <span class="n">save_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_pickle</span><span class="p">(</span><span class="n">save_name</span><span class="p">):</span>
                <span class="n">save_name</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">meta_config</span><span class="o">.</span><span class="n">PICKLE_DATATYPE</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">save_name</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">.</span><span class="n">PICKLE_PROTOCOL</span><span class="p">)</span>
                <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; pickled to &quot;</span> <span class="o">+</span> <span class="n">save_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="c1"># HACK how to solve logger problem?</span>
<span class="c1">#            logger.error(&quot;Could not pickle data, name for file (&quot; +</span>
<span class="c1">#                         str(save_name) + &quot;) is not a string!&quot; +</span>
<span class="c1">#                         &quot;\n Therefore, the following data was only returned&quot; +</span>
<span class="c1">#                         &quot; but not saved! \n Data:&quot; + str(return_value))</span>
    <span class="k">return</span> <span class="n">return_value</span></div>


<div class="viewcode-block" id="try_unpickle"><a class="viewcode-back" href="../../../raredecay.tools.data_tools.html#raredecay.tools.data_tools.try_unpickle">[docs]</a><span class="k">def</span> <span class="nf">try_unpickle</span><span class="p">(</span><span class="n">file_to_unpickle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to unpickle a file and return, otherwise just return input.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_pickle</span><span class="p">(</span><span class="n">file_to_unpickle</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_config</span><span class="o">.</span><span class="n">PICKLE_PATH</span> <span class="o">+</span> <span class="n">file_to_unpickle</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_to_unpickle</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_to_unpickle</span></div>


<span class="c1">#if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#    print &quot;running selftest&quot;</span>
<span class="c1">#    root_dict = dict(</span>
<span class="c1">#        filenames=&#39;/home/mayou/Documents/uniphysik/Bachelor_thesis/analysis/data/test1.root&#39;,</span>
<span class="c1">#        branches=[&#39;B_PT&#39;, &#39;nTracks&#39;],</span>
<span class="c1">#        treename=&#39;DecayTree&#39;,</span>
<span class="c1">#        selection=&#39;B_PT &gt; 10000&#39;</span>
<span class="c1">#        )</span>
<span class="c1">#    df1 = to_pandas(root_dict)</span>
<span class="c1">#    print df1</span>
<span class="c1">#    print &quot;selftest completed!&quot;</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jonas Eschle.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.2.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>